<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Geriatrics Platform Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: white;
            padding: 20px;
        }
        .test-suite {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #00d4ff;
            text-shadow: 0 0 20px rgba(0,212,255,0.5);
        }
        .test-card {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(0,212,255,0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin: 5px;
        }
        .success { background: #10b981; }
        .warning { background: #f59e0b; }
        .error { background: #ef4444; }
        .pending { background: #6b7280; }
        pre {
            background: rgba(0,0,0,0.5);
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <div class="test-suite">
        <h1>üè• Geriatrics Platform Integration Test Suite üáÆüá±</h1>
        
        <div class="test-card">
            <h2>Component Status</h2>
            <div id="component-status">
                <span class="status pending">Drug Database: Loading...</span>
                <span class="status pending">Clinical Calculators: Loading...</span>
                <span class="status pending">Quiz Generator: Loading...</span>
            </div>
        </div>

        <div class="test-card">
            <h2>Integration Test 1: Anticoagulation Decision Support</h2>
            <p>Testing CHA2DS2-VASc + HAS-BLED + Drug Interaction Check</p>
            <button onclick="runAnticoagulationTest()">Run Test</button>
            <pre id="anticoag-result"></pre>
        </div>

        <div class="test-card">
            <h2>Integration Test 2: Comprehensive Geriatric Assessment</h2>
            <p>Testing Fall Risk + Frailty + Medication Review</p>
            <button onclick="runGeriatricAssessment()">Run Test</button>
            <pre id="geriatric-result"></pre>
        </div>

        <div class="test-card">
            <h2>Integration Test 3: Israeli Healthcare Integration</h2>
            <p>Testing Hebrew Drug Search + Sal Coverage + Bituach Leumi Benefits</p>
            <button onclick="runIsraeliIntegration()">Run Test</button>
            <pre id="israeli-result"></pre>
        </div>

        <div class="test-card">
            <h2>System Report</h2>
            <button onclick="generateSystemReport()">Generate Full Report</button>
            <pre id="system-report"></pre>
        </div>
    </div>

    <!-- Load all components -->
    <script src="h5p/israeli-drug-database.js"></script>
    <script src="h5p/advanced-clinical-calculators.js"></script>
    <script src="h5p/enhanced-quiz-generator.js"></script>
    
    <script>
        let componentsLoaded = {
            drugDatabase: false,
            clinicalCalculators: false,
            quizGenerator: false
        };

        // Check component loading
        function checkComponents() {
            const statusDiv = document.getElementById('component-status');
            let html = '';
            
            // Check Drug Database
            if (typeof IsraeliDrugDatabase !== 'undefined') {
                componentsLoaded.drugDatabase = true;
                html += '<span class="status success">‚úì Drug Database: Loaded</span> ';
            } else {
                html += '<span class="status error">‚úó Drug Database: Failed</span> ';
            }
            
            // Check Clinical Calculators
            if (typeof AdvancedClinicalCalculators !== 'undefined') {
                componentsLoaded.clinicalCalculators = true;
                html += '<span class="status success">‚úì Clinical Calculators: Loaded</span> ';
            } else {
                html += '<span class="status error">‚úó Clinical Calculators: Failed</span> ';
            }
            
            // Check Quiz Generator
            if (typeof EnhancedQuizGenerator !== 'undefined') {
                componentsLoaded.quizGenerator = true;
                html += '<span class="status success">‚úì Quiz Generator: Loaded</span> ';
            } else {
                html += '<span class="status error">‚úó Quiz Generator: Failed</span> ';
            }
            
            statusDiv.innerHTML = html;
        }

        // Integration Test 1: Anticoagulation Decision Support
        function runAnticoagulationTest() {
            const result = document.getElementById('anticoag-result');
            let output = "=== ANTICOAGULATION DECISION SUPPORT TEST ===\n\n";
            
            try {
                // Patient scenario
                const patient = {
                    age: 76,
                    sex: 'F',
                    chf: true,
                    hypertension: true,
                    stroke: false,
                    vascular: true,
                    diabetes: true,
                    abnormalRenal: true,
                    bleeding: false,
                    medications: ['warfarin', 'amiodarone', 'metoprolol']
                };
                
                // Calculate stroke risk
                const calc = new AdvancedClinicalCalculators();
                const cha2ds2 = calc.calculateCHA2DS2VASc(patient);
                output += `CHA2DS2-VASc Score: ${cha2ds2.score}\n`;
                output += `Stroke Risk: ${cha2ds2.risk}\n`;
                output += `Annual Stroke Risk: ${cha2ds2.annualStrokeRisk}\n\n`;
                
                // Calculate bleeding risk
                const hasbled = calc.calculateHASBLED({
                    hypertension: patient.hypertension,
                    abnormalRenal: patient.abnormalRenal,
                    abnormalLiver: false,
                    stroke: patient.stroke,
                    bleeding: patient.bleeding,
                    labile: false,
                    elderly: patient.age > 65,
                    drugs: true, // Taking NSAIDs
                    alcohol: false
                });
                output += `HAS-BLED Score: ${hasbled.score}\n`;
                output += `Bleeding Risk: ${hasbled.risk}\n\n`;
                
                // Check drug interactions
                const interactions = IsraeliDrugDatabase.checkInteractions(patient.medications);
                output += `Drug Interactions Found: ${interactions.length}\n`;
                interactions.forEach(int => {
                    output += `  ‚ö†Ô∏è ${int.drug1} + ${int.drug2}: ${int.severity} - ${int.effect}\n`;
                });
                
                // Check Sal coverage for anticoagulants
                output += `\nüíä Sal Coverage for Apixaban:\n`;
                const coverage = IsraeliDrugDatabase.checkSalCoverage('apixaban');
                output += JSON.stringify(coverage, null, 2);
                
                output += "\n\n‚úÖ TEST COMPLETED SUCCESSFULLY";
                result.textContent = output;
                result.style.color = '#10b981';
            } catch(e) {
                result.textContent = `ERROR: ${e.message}`;
                result.style.color = '#ef4444';
            }
        }

        // Integration Test 2: Comprehensive Geriatric Assessment
        function runGeriatricAssessment() {
            const result = document.getElementById('geriatric-result');
            let output = "=== COMPREHENSIVE GERIATRIC ASSESSMENT TEST ===\n\n";
            
            try {
                const calc = new AdvancedClinicalCalculators();
                
                // Patient data
                const patient = {
                    age: 82,
                    medications: ['diazepam', 'omeprazole', 'metformin', 'warfarin'],
                    creatinine: 1.8,
                    gender: 'M',
                    conditions: ['diabetes', 'atrial fibrillation', 'falls']
                };
                
                // Fall Risk Assessment
                const morse = calc.calculateMorseFallScale({
                    fallHistory: 'yes',
                    secondaryDiagnosis: 'yes',
                    ambulatoryAid: 'walker',
                    iv: 'no',
                    gait: 'weak',
                    mentalStatus: 'forgets'
                });
                output += `Morse Fall Scale: ${morse.score} (${morse.risk} risk)\n`;
                output += `MOH Protocol: ${morse.mohProtocol}\n\n`;
                
                // Frailty Assessment
                const frailty = calc.calculateClinicalFrailtyScale({ score: 6 });
                output += `Clinical Frailty Scale: ${frailty.score}\n`;
                output += `Category: ${frailty.category}\n`;
                if (frailty.bituachLeumi) {
                    output += `Bituach Leumi Eligibility: ${frailty.bituachLeumi.eligible ? 'Yes' : 'No'}\n`;
                    if (frailty.bituachLeumi.benefits) {
                        output += `Benefits: ${frailty.bituachLeumi.benefits.join(', ')}\n`;
                    }
                }
                output += "\n";
                
                // Medication Review
                const review = IsraeliDrugDatabase.performComprehensiveMedicationReview(patient);
                output += `Medication Review Summary:\n`;
                output += `  eGFR: ${review.patient.eGFR} mL/min\n`;
                output += `  Drug Interactions: ${review.interactions.length}\n`;
                output += `  STOPP Violations: ${review.stoppViolations.length}\n`;
                output += `  Beers Violations: ${review.beersViolations.length}\n`;
                output += `  Renal Adjustments Needed: ${review.renalAdjustments.length}\n`;
                
                if (review.priorityActions.length > 0) {
                    output += `\nPriority Actions:\n`;
                    review.priorityActions.slice(0, 3).forEach(action => {
                        output += `  ${action.priority}. ${action.action}\n`;
                    });
                }
                
                output += "\n‚úÖ TEST COMPLETED SUCCESSFULLY";
                result.textContent = output;
                result.style.color = '#10b981';
            } catch(e) {
                result.textContent = `ERROR: ${e.message}`;
                result.style.color = '#ef4444';
            }
        }

        // Integration Test 3: Israeli Healthcare Integration
        function runIsraeliIntegration() {
            const result = document.getElementById('israeli-result');
            let output = "=== ISRAELI HEALTHCARE INTEGRATION TEST ===\n\n";
            
            try {
                // Hebrew medication search
                output += "Hebrew Medication Search:\n";
                const hebrewMeds = ['◊ê◊ß◊û◊ï◊ú', '◊®◊ô◊ë◊ï◊ò◊®◊ô◊ú', '◊ß◊ï◊û◊ì◊ô◊ü', '◊§◊®◊û◊ô◊ü'];
                hebrewMeds.forEach(med => {
                    const found = IsraeliDrugDatabase.searchHebrewMedication(med);
                    if (!found.error) {
                        output += `  ‚úì ${med} ‚Üí ${found.genericName} (${found.class})\n`;
                    }
                });
                output += "\n";
                
                // Sal coverage check
                output += "Sal Formulary Coverage:\n";
                const drugs = ['apixaban', 'empagliflozin', 'donepezil'];
                drugs.forEach(drug => {
                    const coverage = IsraeliDrugDatabase.checkSalCoverage(drug);
                    output += `  ${drug}: ${coverage.covered ? '‚úì Covered' : '‚úó Not covered'}\n`;
                    if (coverage.criteria) {
                        output += `    Criteria: ${coverage.criteria}\n`;
                    }
                });
                output += "\n";
                
                // Bituach Leumi benefits based on frailty
                output += "Bituach Leumi Benefits Eligibility:\n";
                const calc = new AdvancedClinicalCalculators();
                const frailtyScores = [3, 5, 7];
                frailtyScores.forEach(score => {
                    const result = calc.calculateClinicalFrailtyScale({ score });
                    output += `  Frailty Score ${score}: ${result.category}\n`;
                    if (result.bituachLeumi && result.bituachLeumi.eligible) {
                        output += `    Eligible for: ${result.bituachLeumi.benefits.join(', ')}\n`;
                    }
                });
                output += "\n";
                
                // Israeli-specific drug alternatives
                output += "Israeli Drug Alternatives:\n";
                const alternatives = IsraeliDrugDatabase.suggestAlternatives('diazepam');
                if (alternatives) {
                    output += `  Diazepam alternatives: ${alternatives.alternatives.slice(0, 3).join(', ')}\n`;
                    output += `  Reason: ${alternatives.reason}\n`;
                }
                
                output += "\n‚úÖ TEST COMPLETED SUCCESSFULLY";
                result.textContent = output;
                result.style.color = '#10b981';
            } catch(e) {
                result.textContent = `ERROR: ${e.message}`;
                result.style.color = '#ef4444';
            }
        }

        // Generate System Report
        function generateSystemReport() {
            const result = document.getElementById('system-report');
            let output = "=== GERIATRICS PLATFORM SYSTEM REPORT ===\n\n";
            
            try {
                // Database statistics
                const dbStats = IsraeliDrugDatabase.generateReport();
                output += "üìä Drug Database Statistics:\n";
                output += `  Total Medications: ${dbStats.totalMedications}\n`;
                output += `  Hebrew Mappings: ${dbStats.hebrewMappings}\n`;
                output += `  Brand Names: ${dbStats.brandNames}\n`;
                output += `  STOPP Criteria: ${dbStats.stoppCriteria}\n`;
                output += `  START Criteria: ${dbStats.startCriteria}\n`;
                output += `  Beers Criteria: ${dbStats.beersCriteria}\n`;
                output += `  Sal Coverage Entries: ${dbStats.salCoverage}\n\n`;
                
                // Clinical Calculators available
                const calc = new AdvancedClinicalCalculators();
                output += "üßÆ Clinical Calculators Available:\n";
                const calculators = [
                    'CHA2DS2-VASc Score',
                    'HAS-BLED Score',
                    'Morse Fall Scale',
                    'Clinical Frailty Scale',
                    'FRAIL Scale',
                    'Charlson Comorbidity Index',
                    'Mini Nutritional Assessment',
                    'MMSE',
                    'Geriatric Depression Scale',
                    'Katz ADL',
                    'Lawton IADL',
                    'Barthel Index',
                    'SPPB',
                    'Timed Up and Go',
                    'MoCA',
                    'CAM',
                    'Norton Scale',
                    'Braden Scale',
                    'CAGE Questionnaire',
                    'MUST Score'
                ];
                calculators.forEach(name => {
                    output += `  ‚úì ${name}\n`;
                });
                output += "\n";
                
                // Quiz Generator capabilities
                if (typeof EnhancedQuizGenerator !== 'undefined') {
                    const quiz = new EnhancedQuizGenerator();
                    output += "üìö Quiz Generator Features:\n";
                    output += `  ‚úì Clinical Case Scenarios\n`;
                    output += `  ‚úì Adaptive Learning\n`;
                    output += `  ‚úì Confidence Tracking\coln`;
                    output += `  ‚úì Spaced Repetition (Fibonacci)\n`;
                    output += `  ‚úì Performance Analytics\n\n`;
                }
                
                // Integration features
                output += "üîó Integration Features:\n";
                output += `  ‚úì Hebrew-English Drug Mapping\n`;
                output += `  ‚úì Sal Formulary Integration\n`;
                output += `  ‚úì Bituach Leumi Benefits\n`;
                output += `  ‚úì MOH Protocols\n`;
                output += `  ‚úì Israeli Clinical Guidelines\n`;
                output += `  ‚úì Shaare Zedek Standards\n\n`;
                
                output += "‚úÖ SYSTEM FULLY OPERATIONAL\n";
                output += `Generated: ${new Date().toLocaleString('he-IL')}`;
                
                result.textContent = output;
                result.style.color = '#10b981';
            } catch(e) {
                result.textContent = `ERROR: ${e.message}`;
                result.style.color = '#ef4444';
            }
        }

        // Initialize
        window.onload = function() {
            setTimeout(checkComponents, 1000);
        };
    </script>
</body>
</html>